<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ruteador - Preservar Columnas Vac√≠as</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #f4f7f6; }
        #sidebar { width: 340px; padding: 20px; background: #2c3e50; color: white; display: flex; flex-direction: column; z-index: 1000; box-shadow: 2px 0 15px rgba(0,0,0,0.3); }
        #map { flex-grow: 1; }
        h2 { font-size: 1.2rem; color: #3498db; margin: 0 0 15px 0; border-bottom: 1px solid #34495e; padding-bottom: 10px; }
        .btn { width: 100%; padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; margin-bottom: 10px; }
        #edit-panel { background: #34495e; padding: 15px; border-radius: 8px; margin: 10px 0; display: none; border: 1px solid #5d6d7e; }
        label { font-size: 0.7rem; color: #bdc3c7; text-transform: uppercase; font-weight: bold; }
        #display-address { background: #1a252f; padding: 10px; border-radius: 4px; border-left: 3px solid #3498db; font-size: 0.9rem; margin-top: 5px; color: #ecf0f1; }
        input[type="text"] { width: 100%; padding: 10px; border-radius: 4px; border: none; box-sizing: border-box; background: #ecf0f1; margin-top: 5px; font-family: monospace; }
        .btn-save { background: #f1c40f; color: #2c3e50; }
        .btn-download { background: #27ae60; color: white; display: none; margin-top: 10px; }
        .order-label { background: transparent; border: none; box-shadow: none; color: #2c3e50; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 0px white, -1px -1px 0px white; pointer-events: none; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Ruteo Centralizado Caminantes</h2>
        <input type="file" id="excel-input" accept=".xlsx, .xls, .csv" style="margin-bottom: 20px; color: white;" />
        
        <div id="edit-panel">
            <label>üìç Direcci√≥n Destino</label>
            <div id="display-address">-</div>
            <hr style="border: 0; border-top: 1px solid #5d6d7e; margin: 15px 0;">
            <label>Latitud</label>
            <input type="text" id="side-lat">
            <label>Longitud</label>
            <input type="text" id="side-lng">
            <button class="btn btn-save" onclick="guardarCambiosLaterales()">‚úî Actualizar Geo</button>
        </div>

        <button id="btnDownload" class="btn btn-download" onclick="descargarExcel()">üì• Descargar Excel Completo</button>
        <button class="btn" style="background:#e74c3c; color:white; margin-top: auto;" onclick="location.reload()">üîÑ Reiniciar</button>
        <p style="text-align: center;">Equipos en ruta: <b id="count">0</b></p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        const map = L.map('map').setView([-34.6037, -58.3816], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        let puntosCargados = []; 
        let rutaSeleccionada = []; 
        let lineaRuta = null;
        let marcadorActivo = null;

        document.getElementById('excel-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                // EL CAMBIO EST√Å AQU√ç: defval: "" asegura que las celdas vac√≠as se mantengan como strings vac√≠os
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                dibujarPuntos(json);
            };
            reader.readAsArrayBuffer(e.target.files[0]);
        });

        function dibujarPuntos(datos) {
            datos.forEach((fila, index) => {
                const lat = fila.Latitud || fila.latitud || fila.Lat;
                const lng = fila.Longitud || fila.longitud || fila.Lng;

                if (lat && lng) {
                    const marker = L.circleMarker([parseFloat(lat), parseFloat(lng)], {
                        radius: 8, fillColor: "white", color: "#e67e22", weight: 2, fillOpacity: 1
                    }).addTo(map);

                    marker.datosOriginales = JSON.parse(JSON.stringify(fila));
                    marker.enRuta = false;
                    marker.on('click', () => gestionarClic(marker));
                    puntosCargados.push(marker);
                }
            });
            if (puntosCargados.length > 0) {
                const group = new L.featureGroup(puntosCargados);
                map.fitBounds(group.getBounds(), {padding:[50,50]});
            }
        }

        function gestionarClic(marker) {
            if (marcadorActivo && marcadorActivo !== marker) refrescarEstilo(marcadorActivo);
            marcadorActivo = marker;

            if (!marker.enRuta) {
                marker.enRuta = true;
                rutaSeleccionada.push(marker);
            } else {
                marker.enRuta = false;
                marker.unbindTooltip();
                rutaSeleccionada = rutaSeleccionada.filter(m => m !== marker);
            }

            document.getElementById('edit-panel').style.display = 'block';
            document.getElementById('display-address').innerText = marker.datosOriginales["Direcci√≥n destino"] || "Sin direcci√≥n";
            document.getElementById('side-lat').value = marker.getLatLng().lat;
            document.getElementById('side-lng').value = marker.getLatLng().lng;

            actualizarGraficos();
        }

        function refrescarEstilo(marker) {
            marker.setStyle({ color: marker.enRuta ? "#2ecc71" : "#e67e22", weight: marker.enRuta ? 4 : 2 });
        }

        function actualizarGraficos() {
            if (lineaRuta) map.removeLayer(lineaRuta);
            const coords = [];
            rutaSeleccionada.forEach((m, index) => {
                m.setStyle({ color: (m === marcadorActivo) ? '#3498db' : '#2ecc71', weight: 4 });
                m.unbindTooltip();
                m.bindTooltip((index + 1).toString(), { permanent: true, direction: 'center', className: 'order-label' }).openTooltip();
                coords.push(m.getLatLng());
            });

            if (marcadorActivo && !marcadorActivo.enRuta) marcadorActivo.setStyle({ color: '#3498db', weight: 6 });

            if (coords.length > 1) {
                lineaRuta = L.polyline(coords, {color: '#27ae60', weight: 3, dashArray: '5, 10'}).addTo(map);
            }
            document.getElementById('count').textContent = rutaSeleccionada.length;
            document.getElementById('btnDownload').style.display = rutaSeleccionada.length > 0 ? 'block' : 'none';
        }

        window.guardarCambiosLaterales = function() {
            if (!marcadorActivo) return;
            const nLat = parseFloat(document.getElementById('side-lat').value);
            const nLng = parseFloat(document.getElementById('side-lng').value);
            if (!isNaN(nLat) && !isNaN(nLng)) {
                marcadorActivo.setLatLng([nLat, nLng]);
                const latKey = Object.keys(marcadorActivo.datosOriginales).find(k => k.toLowerCase().startsWith('lat')) || 'Latitud';
                const lngKey = Object.keys(marcadorActivo.datosOriginales).find(k => k.toLowerCase().startsWith('lng')) || 'Longitud';
                marcadorActivo.datosOriginales[latKey] = nLat;
                marcadorActivo.datosOriginales[lngKey] = nLng;
                actualizarGraficos();
            }
        };

        function descargarExcel() {
            const dataFinal = rutaSeleccionada.map((m, index) => {
                let fila = {...m.datosOriginales};
                fila["Orden"] = index + 1;
                return fila;
            });
            const ws = XLSX.utils.json_to_sheet(dataFinal);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ruta");
            XLSX.writeFile(wb, "Ruta_Completa.xlsx");
        }
    </script>
</body>
</html>